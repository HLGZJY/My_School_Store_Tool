# 校园信息聚合小程序 - 数据库设计文档

> **文档版本**：v1.1
> **更新日期**：2026-02-13
> **变更说明**：用户标识体系重构，users 表主键改为 openid

---

## 数据库概览

本系统采用DCloud云开发提供的云数据库（MongoDB），使用文档型数据模型。

---

## 一、集合（表）设计

### 1.1 用户表 (users)

存储用户基本信息和角色配置。

```javascript
{
    // 主键：使用微信 openid（v1.1+），而非自动生成的 ObjectId
    _id: "微信OpenID（如：oMl6L5Xxx...）",
    openid: "微信OpenID（冗余存储，便于查询）",
    nickname: "用户昵称",
    avatar: "头像URL",
    role: "用户角色 | student | teacher | admin",
    roleDetail: {
        // 学生角色详情
        student: {
            major: "专业名称",
            grade: "年级：2021/2022/2023/2024",
            interests: ["标签1", "标签2"] // 兴趣标签数组
        },
        // 教师角色详情
        teacher: {
            department: "所属院系",
            title: "职称：助教/讲师/副教授/教授",
            researchField: "研究方向"
        },
        // 行政人员角色详情
        admin: {
            department: "所属部门",
            duties: "职责范围"
        }
    },
    settings: {
        fontSize: "字体大小：small/medium/large",
        darkMode: "深色模式：false（预留）",
        language: "语言：zh-CN（预留）"
    },
    stats: {
        readCount: 0,          // 阅读文章数
        collectCount: 0,       // 收藏文章数
        searchCount: 0         // 搜索次数
    },
    subscribeSources: [        // 订阅的数据源ID数组
        "source_id_1",
        "source_id_2"
    ],
    createTime: 1707456000000, // 创建时间戳
    updateTime: 1707542400000, // 更新时间戳
    lastLoginTime: 1707542400000 // 最后登录时间
}
```

**索引设计：**
- `_id`（主键）：使用 openid 作为主键
- `openid`（唯一索引）：冗余索引，便于通过 openid 查询
- `createTime`（普通索引）：按注册时间排序

---

### 重要变更说明（v1.1）

| 版本 | _id 来源 | 说明 |
|-----|---------|------|
| v1.0 | 自动生成的 ObjectId | 切换环境时 _id 会变化 |
| v1.1 | 微信 openid | 环境切换时保持不变，统一标识 |

**变更原因**：解决跨环境数据关联失效问题。

---

### 1.2 文章表 (articles)

存储所有文章内容。

```javascript
{
    _id: "文章ID（自动生成）",
    title: "文章标题",
    content: "正文内容（富文本HTML）",
    summary: "AI生成摘要（100-200字）",
    plainText: "纯文本内容（用于搜索）",

    // 分类信息
    category: "一级分类 | notice | academic | activity | service",

    // 标签信息
    tags: {
        source: ["教务处", "计算机学院"],     // 来源标签
        role: ["本科生", "通用"],             // 角色标签
        custom: ["考试", "讲座"]              // 自定义标签
    },

    // 紧急程度
    urgency: "紧急程度 | high/medium/low",
    urgentTag: "紧急标签展示文字：置顶24小时/本周截止/即将开始",

    // 元数据
    sourceId: "数据源ID（关联sources表）",
    sourceName: "数据源名称",
    author: "发布者（可选）",
    originalUrl: "原文链接",
    publishTime: 1707456000000, // 发布时间戳
    expireTime: 1707801600000,  // 过期时间戳（可选，用于活动等）

    // 统计数据
    stats: {
        viewCount: 0,      // 阅读量
        collectCount: 0,   // 收藏量
        shareCount: 0      // 分享量
    },

    // AI处理信息
    aiProcess: {
        processed: true,    // 是否已AI处理
        confidence: 95,     // AI置信度 0-100
        model: "moonshot-v1-8k",
        processTime: 1707456000000
    },

    // 审核状态
    status: "状态 | published/draft/pending/rejected",
    reviewNote: "审核备注（可选）",

    // 向量字段（预留，用于语义搜索）
    vector: [/* 嵌入向量数组，长度1536 */],

    createTime: 1707456000000,
    updateTime: 1707542400000
}
```

**索引设计：**
- category（普通索引）：按分类筛选
- publishTime（普通索引）：按时间排序（倒序）
- sourceId（普通索引）：按数据源筛选
- status（普通索引）：按发布状态筛选
- 复合索引：[category, publishTime]（用于首页列表查询）
- 复合索引：[status, publishTime]（用于管理后台查询）

---

### 1.3 数据源表 (sources)

存储所有数据源配置。

```javascript
{
    _id: "数据源ID（自动生成）",
    name: "数据源名称：教务处",
    description: "数据源描述",

    // 数据源类型
    type: "类型 | rss/api/manual/website",

    // 访问配置
    config: {
        // RSS源配置
        rss: {
            url: "https://example.edu.cn/rss.xml",
            encoding: "utf-8"
        },
        // API源配置
        api: {
            url: "https://api.example.edu.cn/notices",
            method: "GET",
            headers: {
                "Authorization": "Bearer xxx"
            },
            dataPath: "data.list" // 数据提取路径
        },
        // 网站源配置（手动配置XPath）
        website: {
            url: "https://example.edu.cn/notices",
            titleXPath: "//h1[@class='title']/text()",
            contentXPath: "//div[@class='content']",
            timeXPath: "//span[@class='date']/text()"
        }
    },

    // 标签配置（自动添加到该源的所有文章）
    defaultTags: {
        source: ["教务处"],
        role: ["本科生", "研究生", "教职工"]
    },

    // 采集配置
    schedule: {
        interval: 3600000,  // 采集间隔（毫秒）
        nextRunTime: 1707542400000,
        lastRunTime: 1707456000000,
        enabled: true
    },

    // 统计信息
    stats: {
        totalArticles: 156,      // 总文章数
        lastFetchCount: 5,      // 最后一次获取文章数
        errorCount: 0,          // 错误次数
        lastError: null         // 最后错误信息
    },

    status: "状态 | active/inactive/error",
    createTime: 1707000000000,
    updateTime: 1707542400000
}
```

**索引设计：**
- type（普通索引）：按类型筛选
- status（普通索引）：按状态筛选
- schedule.enabled（普通索引）：查找启用的源

---

### 1.4 收藏表 (collections)

存储用户收藏记录。

```javascript
{
    _id: "收藏ID（自动生成）",
    openid: "用户OpenID（v1.1+使用openid关联）",
    articleId: "文章ID",
    folderId: "收藏夹ID（预留，null为默认收藏夹）",

    // 冗余数据（提升查询性能）
    article: {
        title: "文章标题",
        summary: "摘要",
        category: "分类",
        coverImage: "封面图URL",
        sourceName: "来源名称"
    },

    createTime: 1707542400000
}
```

**索引设计：**
- `openid`（普通索引）：查询用户收藏（v1.1+）
- `articleId`（普通索引）：查询文章被谁收藏
- 复合索引：`[openid, createTime]`（按用户和时间排序）
- 唯一索引：`[openid, articleId]`（防止重复收藏）

---

### 1.5 阅读历史表 (reading_history)

存储用户阅读历史。

```javascript
{
    _id: "历史ID（自动生成）",
    openid: "用户OpenID（v1.1+使用openid关联）",
    articleId: "文章ID",

    // 冗余数据
    article: {
        title: "文章标题",
        category: "分类",
        sourceName: "来源名称"
    },

    readTime: 1707542400000, // 阅读时间戳
    readDuration: 30        // 阅读时长（秒）
}
```

**索引设计：**
- userId（普通索引）：查询用户历史
- 复合索引：[userId, readTime]（按用户和时间排序）
- readTime（TTL索引）：30天后自动删除

---

### 1.6 搜索历史表 (search_history)

存储用户搜索历史。

```javascript
{
    _id: "搜索ID（自动生成）",
    userId: "用户ID（可选，未登录为null）",
    keyword: "搜索关键词",
    resultCount: 25, // 搜索结果数量
    searchTime: 1707542400000
}
```

**索引设计：**
- userId（普通索引）：查询用户历史
- searchTime（TTL索引）：30天后自动删除

---

### 1.7 热门搜索表 (hot_keywords)

存储热门搜索关键词（统计结果）。

```javascript
{
    _id: "关键词ID（自动生成）",
    keyword: "搜索关键词",
    count: 156,      // 搜索次数
    updateTime: 1707542400000
}
```

**索引设计：**
- count（普通索引）：按搜索量排序
- updateTime（普通索引）：按时间排序

---

### 1.8 消息表 (messages)

存储系统消息和通知。

```javascript
{
    _id: "消息ID（自动生成）",
    userId: "接收用户ID（null表示全员消息）",

    // 消息内容
    type: "消息类型 | system/update/content",
    title: "消息标题",
    content: "消息内容",
    link: "跳转链接（可选）",

    // 状态
    isRead: false,        // 是否已读
    readTime: null,       // 阅读时间

    createTime: 1707542400000,
    expireTime: 1710220800000 // 过期时间（可选）
}
```

**索引设计：**
- userId（普通索引）：查询用户消息
- isRead（普通索引）：筛选未读消息
- 复合索引：[userId, createTime]（按用户和时间排序）
- 复合索引：[isRead, createTime]（查询所有未读消息）

---

### 1.9 订阅更新表 (subscription_updates)

存储订阅源更新通知。

```javascript
{
    _id: "更新ID（自动生成）",
    sourceId: "数据源ID",
    sourceName: "数据源名称",
    articleIds: ["article_id_1", "article_id_2"], // 新增文章ID列表
    articleCount: 5, // 新增文章数量
    updateTime: 1707542400000
}
```

**索引设计：**
- sourceId（普通索引）：按数据源查询
- updateTime（TTL索引）：7天后自动删除

---

### 1.10 系统配置表 (system_config)

存储系统配置参数。

```javascript
{
    _id: "配置ID（自动生成））",
    key: "配置键",
    value: "配置值（可以是字符串、数字、对象等）",
    description: "配置描述",
    updateTime: 1707542400000
}
```

**预置配置：**

| Key | Value | 说明 |
|-----|-------|------|
| hot_search_update_interval | 3600000 | 热门搜索更新间隔 |
| hot_search_limit | 20 | 热门搜索展示数量 |
| article_page_size | 15 | 每页文章数量 |
| history_max_count | 50 | 阅读历史最大保留数 |
| ai_confidence_threshold | 80 | AI置信度阈值 |

---

### 1.11 审核队列表 (review_queue)

存储待审核文章（AI置信度低于阈值）。

```javascript
{
    _id: "待审核ID（自动生成）",
    articleId: "文章ID",

    // 原始数据
    rawData: {
        title: "原标题",
        content: "原始内容",
        url: "原文链接"
    },

    // AI处理结果
    aiResult: {
        processed: true,
        confidence: 65,
        extractedData: { /* AI提取的数据 */ },
        processTime: 1707542400000
    },

    status: "待审核状态 | pending/approved/rejected",
    reviewerId: "审核人ID（可选）",
    reviewTime: null,
    reviewNote: "审核备注（可选）",

    createTime: 1707542400000
}
```

**索引设计：**
- status（普通索引）：按审核状态筛选
- createTime（普通索引）：按创建时间排序

---

### 1.12 操作日志表 (operation_logs)

记录关键操作日志。

```javascript
{
    _id: "日志ID（自动生成）",
    userId: "用户ID（可选）",
    action: "操作类型 | login/logout/collect/uncollect/read/search",
    targetId: "目标ID（文章ID等）",
    target: "目标类型 | article/collection/source",
    detail: "操作详情（JSON对象）",
    ip: "IP地址（可选）",
    userAgent: "用户代理（可选）",
    createTime: 1707542400000
}
```

**索引设计：**
- userId（普通索引）：查询用户操作
- action（普通索引）：按操作类型筛选
- createTime（TTL索引）：90天后自动删除

---

## 二、数据关系图

```
┌──────────────┐
│    users      │
│  (_id=openid) │
└──────┬───────┘
       │
       ├───────┐───────┐───────┐
       │       │       │       │
       ▼       ▼       ▼       ▼
┌──────────┐ ┌─────────────┐ ┌──────────┐ ┌─────────────┐
│collections│ │reading_history│ │search_history │ │  messages   │
│(openid)   │ │  (openid)    │ │  (openid)    │ │  (openid)   │
└─────┬────┘ └─────────────┘ └──────────┘ └─────────────┘
      │
      │  articleId
      ▼
┌──────────────┐
│   articles   │◄────────────┐
└──────┬───────┘             │
       │                     │
       ▼                     │
┌──────────────┐             │
│   sources    │─────────────┘
│  (sourceId)  │
└──────────────┘
```

**说明**：所有用户相关表使用 `openid` 关联用户，而非 users 表的 `_id`。

---

## 三、数据库安全策略

### 3.1 权限控制

使用云开发数据库权限规则：

| 集合 | 读权限 | 写权限 |
|-----|--------|--------|
| users | 仅本人读写 | 仅本人写入 |
| articles | 所有人读 | 仅云函数写 |
| sources | 所有云函数 | 仅云函数 |
| collections | 仅本人读写 | 仅本人写入 |
| reading_history | 仅本人读写 | 仅本人写入 |
| search_history | 仅本人读写 | 仅本人写入 |
| messages | 仅本人读写 | 仅云函数写入 |
| system_config | 所有云函数 | 仅云函数 |
| review_queue | 所有云函数 | 仅云函数 |
| operation_logs | 所有云函数 | 仅云函数 |

### 3.2 数据脱敏

敏感字段处理：
- openid：仅用户本人和云函数可见
- 手机号：不存储
- IP地址：脱敏处理后存储

---

## 四、数据备份与恢复

### 4.1 备份策略

| 备份类型 | 频率 | 保留时间 |
|---------|------|---------|
| 全量备份 | 每天凌晨3点 | 30天 |
| 增量备份 | 每小时 | 7天 |

### 4.2 恢复流程

1. 确认恢复时间点
2. 选择对应备份文件
3. 执行恢复操作
4. 验证数据完整性

---

## 五、数据迁移脚本

### 5.1 初始化脚本

```javascript
// 云函数：initDatabase
'use strict';

exports.main = async (event, context) => {
    const db = uniCloud.database();
    const $ = db.command.aggregate;

    // 初始化系统配置
    const configs = [
        { key: 'hot_search_update_interval', value: 3600000, description: '热门搜索更新间隔（毫秒）' },
        { key: 'hot_search_limit', value: 20, description: '热门搜索展示数量' },
        { key: 'article_page_size', value: 15, description: '每页文章数量' },
        { key: 'history_max_count', value: 50, description: '阅读历史最大保留数' },
        { key: 'ai_confidence_threshold', value: 80, description: 'AI置信度阈值' }
    ];

    for (const config of configs) {
        await db.collection('system_config').add({
            key: config.key,
            value: config.value,
            description: config.description,
            updateTime: Date.now()
        });
    }

    // 初始化默认数据源
    const sources = [
        {
            name: '教务处',
            description: '教务处官网通知',
            type: 'rss',
            config: {
                rss: {
                    url: 'https://example.edu.cn/jwc/rss.xml',
                    encoding: 'utf-8'
                }
            },
            defaultTags: {
                source: ['教务处'],
                role: ['本科生', '研究生', '教职工']
            },
            schedule: {
                interval: 3600000,
                enabled: false // 需配置真实地址后启用
            },
            status: 'inactive',
            createTime: Date.now()
        },
        {
            name: '图书馆',
            description: '图书馆官方信息',
            type: 'rss',
            config: {
                rss: {
                    url: 'https://example.edu.cn/library/rss.xml',
                    encoding: 'utf-8'
                }
            },
            defaultTags: {
                source: ['图书馆'],
                role: ['本科生', '研究生', '教职工']
            },
            schedule: {
                interval: 3600000,
                enabled: false
            },
            status: 'inactive',
            createTime: Date.now()
        }
    ];

    for (const source of sources) {
        await db.collection('sources').add(source);
    }

    return {
        code: 0,
        message: '数据库初始化成功'
    };
};
```

### 5.2 清理过期数据脚本

```javascript
// 云函数：cleanupExpiredData
'use strict';

exports.main = async (event, context) => {
    const db = uniCloud.database();
    const now = Date.now();

    // 清理过期消息
    await db.collection('messages').where({
        expireTime: db.command.lt(now)
    }).remove();

    // 清理30天前的搜索历史
    const thirtyDaysAgo = now - 30 * 24 * 60 * 60 * 1000;
    await db.collection('search_history').where({
        searchTime: db.command.lt(thirtyDaysAgo)
    }).remove();

    // 清理90天前的操作日志
    const ninetyDaysAgo = now - 90 * 24 * 60 * 60 * 1000;
    await db.collection('operation_logs').where({
        createTime: db.command.lt(ninetyDaysAgo)
    }).remove();

    return {
        code: 0,
        message: '过期数据清理完成'
    };
};
```

---

## 六、性能优化建议

### 6.1 查询优化

1. 使用聚合管道减少数据传输
2. 合理使用投影字段，只返回需要的字段
3. 对大集合使用分页查询
4. 复杂查询使用索引优化

### 6.2 数据冗余

对于频繁联合查询的场景，进行适当的数据冗余：

| 集合 | 冗余字段 | 冗余原因 |
|-----|---------|---------|
| collections | article.title, article.summary | 避免联表查询 |
| reading_history | article.title | 避免联表查询 |
| search_history | resultCount | 用于统计分析 |

### 6.3 缓存策略

- 热门数据使用云缓存（如热门搜索、排行榜）
- 用户会话数据本地存储
- 配置数据定期刷新缓存

---

## 附录：数据库索引汇总

| 集合 | 索引名称 | 字段 | 类型 | 说明 | 版本 |
|-----|---------|------|------|------|------|
| users | primary | _id | 主键 | 使用 openid 作为主键 | v1.1 |
| users | idx_openid | openid | 唯一 | 微信OpenID（冗余） | v1.1 |
| users | idx_createTime | createTime | 普通 | 按注册时间 | - |
| articles | idx_category | category | 普通 | 按分类 | - |
| articles | idx_publishTime | publishTime | 普通 | 按时间 | - |
| articles | idx_sourceId | sourceId | 普通 | 按数据源 | - |
| articles | idx_status | status | 普通 | 按状态 | - |
| articles | idx_category_time | [category, publishTime] | 复合 | 首页列表 | - |
| articles | idx_status_time | [status, publishTime] | 复合 | 后台管理 | - |
| collections | idx_openid | openid | 普通 | 按用户 | v1.1 |
| collections | idx_articleId | articleId | 普通 | 按文章 | - |
| collections | idx_openid_time | [openid, createTime] | 复合 | 用户收藏 | v1.1 |
| collections | idx_openid_article | [openid, articleId] | 唯一 | 防重复 | v1.1 |
| reading_history | idx_openid | openid | 普通 | 按用户 | v1.1 |
| reading_history | idx_openid_time | [openid, readTime] | 复合 | 用户历史 | v1.1 |
| reading_history | idx_readTime_ttl | readTime | TTL | 30天过期 | - |
| search_history | idx_openid | openid | 普通 | 按用户 | v1.1 |
| search_history | idx_searchTime_ttl | searchTime | TTL | 30天过期 | - |
| hot_keywords | idx_count | count | 普通 | 按热度 | - |
| hot_keywords | idx_updateTime | updateTime | 普通 | 按时间 | - |
| messages | idx_openid | openid | 普通 | 按用户 | v1.1 |
| messages | idx_isRead | isRead | 普通 | 按状态 | - |
| messages | idx_openid_time | [openid, createTime] | 复合 | 用户消息 | v1.1 |
| messages | idx_read_time | [isRead, createTime] | 复合 | 未读消息 | - |
| sources | idx_type | type | 普通 | 按类型 | - |
| sources | idx_status | status | 普通 | 按状态 | - |
| sources | idx_enabled | schedule.enabled | 普通 | 按启用状态 | - |
| review_queue | idx_status | status | 普通 | 按状态 | - |
| review_queue | idx_createTime | createTime | 普通 | 按时间 | - |
| operation_logs | idx_openid | openid | 普通 | 按用户 | v1.1 |
| operation_logs | idx_action | action | 普通 | 按操作 | - |
| operation_logs | idx_createTime_ttl | createTime | TTL | 90天过期 | - |

**版本说明**：v1.1 为用户标识体系重构后的索引（2026-02-12）。
