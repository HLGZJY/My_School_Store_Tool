# 校园信息聚合小程序 - 总体开发文档

## 项目简介

**项目名称**：校园信息聚合小程序
**项目类型**：微信小程序（个人备案）
**开发周期**：约6-8周
**技术栈**：uni-app + DCloud云开发 + Moonshot AI

---

## 一、项目概述

### 1.1 项目背景

校园信息分散在教务处官网、图书馆官网、各类公众号等多个渠道，学生和教职工需要逐个查看，效率低下。本小程序通过聚合这些信息，提供统一的访问入口，并根据用户角色智能推荐相关内容，提升信息获取效率。

### 1.2 核心价值

| 价值点 | 说明 |
|-------|------|
| 信息聚合 | 统一访问入口，无需逐个查看多个渠道 |
| 智能推荐 | 基于用户角色和浏览历史推荐相关内容 |
| AI处理 | 自动提取摘要、标签，提升阅读效率 |
| 个人定制 | 用户可订阅感兴趣的信息源 |
| 消息通知 | 订阅源更新及时提醒 |

### 1.3 目标用户

- **在校学生**：关注课程通知、考试安排、社团活动、就业信息
- **教师**：关注教务通知、科研申报、学术会议
- **行政人员**：关注校内公文、会议通知、政策文件

---

## 二、技术架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                        用户层                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────────────────┐   │
│  │ 微信小程序 │  │ 管理后台  │  │ 数据采集任务         │   │
│  │ (uni-app) │  │ (网页)   │  │ (定时触发)          │   │
│  └──────────┘  └──────────┘  └──────────────────────┘   │
└────────────────────────────┬────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────┐
│                     云函数层                             │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌──────────────┐   │
│  │ 用户相关 │ │ 文章相关 │ │ 搜索相关 │ │ 数据同步     │   │
│  │ 云函数   │ │ 云函数   │ │ 云函数   │ │ 云函数       │   │
│  └─────────┘ └─────────┘ └─────────┘ └──────────────┘   │
└────────────────────────────┬────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────┐
│                     数据层                               │
│  ┌─────────────┐ ┌─────────────┐ ┌──────────────────┐   │
│  │ 云数据库     │ │ 云存储       │ │ 云缓存           │   │
│  │ (MongoDB)   │ │ (文件存储)   │ │ (Redis)          │   │
│  └─────────────┘ └─────────────┘ └──────────────────┘   │
└────────────────────────────┬────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────┐
│                     外部服务层                           │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐    │
│  │ 微信登录API   │ │ Moonshot AI  │ │ 第三方数据源   │    │
│  │              │ │ API          │ │ (RSS/API)     │    │
│  └──────────────┘ └──────────────┘ └──────────────┘    │
└─────────────────────────────────────────────────────────┘
```

### 2.2 技术栈详解

| 层级 | 技术选型 | 版本 | 说明 |
|-----|---------|------|------|
| 前端框架 | uni-app | 3.0+ | 跨平台框架 |
| UI组件 | uni-ui | 最新版 | 官方组件库 |
| 状态管理 | Vuex/Pinia | - | 状态管理 |
| 后端服务 | DCloud云开发 | - | 云函数、云数据库、云存储 |
| 数据库 | MongoDB | - | 文档型数据库 |
| AI服务 | Moonshot API | v1 | 文本处理 |
| 开发工具 | HBuilderX | 最新版 | 官方IDE |

### 2.3 项目目录结构

```
My_School_Store_Tool/
├── docs/                            # 文档目录
│   ├── 完整需求文档.md
│   ├── 数据库设计文档.md
│   ├── API接口文档.md
│   ├── 云函数设计文档.md
│   └── 总体开发文档.md
│
├── pages/                           # 页面目录
│   ├── index/                      # 首页
│   │   ├── index.vue
│   │   └── components/
│   │       ├── ArticleCard.vue
│   │       ├── RecommendCard.vue
│   │       └── SearchBar.vue
│   │
│   ├── discover/                    # 发现页
│   │   ├── discover.vue
│   │   └── components/
│   │       ├── HotRanking.vue
│   │       ├── TagCloud.vue
│   │       └── Timeline.vue
│   │
│   ├── detail/                      # 详情页
│   │   └── detail.vue
│   │
│   ├── mine/                        # 我的页面
│   │   ├── mine.vue
│   │   └── components/
│   │       ├── UserInfo.vue
│   │       └── MenuList.vue
│   │
│   ├── role/                        # 角色选择页
│   │   └── role.vue
│   │
│   ├── collection/                  # 收藏页
│   │   └── collection.vue
│   │
│   ├── history/                     # 阅读历史页
│   │   └── history.vue
│   │
│   ├── message/                     # 消息页
│   │   └── message.vue
│   │
│   ├── settings/                    # 设置页
│   │   └── settings.vue
│   │
│   ├── subscribe/                   # 订阅管理页
│   │   └── subscribe.vue
│   │
│   ├── about/                       # 关于页
│   │   └── about.vue
│   │
│   ├── login/                       # 登录页（首次进入）
│   │   └── login.vue
│   │
│   └── search/                      # 搜索结果页
│       └── search.vue
│
├── components/                      # 公共组件
│   ├── ArticleCard.vue              # 文章卡片
│   ├── SearchBar.vue                # 搜索栏
│   ├── TabBar.vue                  # 底部导航
│   ├── TagItem.vue                 # 标签组件
│   ├── EmptyState.vue              # 空状态
│   └── LoadingMore.vue             # 加载更多
│
├── store/                           # 状态管理
│   ├── index.js
│   ├── modules/
│   │   ├── user.js
│   │   ├── article.js
│   │   └── config.js
│
├── utils/                           # 工具函数
│   ├── request.js                  # 请求封装
│   ├── storage.js                  # 本地存储
│   ├── format.js                   # 格式化
│   ├── validator.js                # 验证器
│   └── constants.js                # 常量定义
│
├── api/                             # API接口
│   ├── user.js
│   ├── article.js
│   ├── collection.js
│   ├── search.js
│   └── system.js
│
├── static/                          # 静态资源
│   ├── images/
│   │   ├── logo.png
│   │   ├── empty.png
│   │   └── loading.gif
│   └── icons/
│       ├── tabbar/
│       └── common/
│
├── uniCloud-aliyun/                  # 云开发
│   ├── cloudfunctions/             # 云函数
│   │   ├── login/                 # 已完成
│   │   ├── getUserInfo/          # 待开发
│   │   ├── setUserRole/          # 待开发
│   │   ├── getArticles/           # 待开发
│   │   ├── searchArticles/        # 待开发
│   │   ├── collectArticle/        # 待开发
│   │   ├── syncData/            # 待开发
│   │   ├── processArticle/       # 待开发
│   │   ├── updateHotKeywords/    # 待开发
│   │   ├── cleanupExpiredData/   # 待开发
│   │   └── ...
│   │
│   └── database/                    # 数据库
│       ├── db_init.json          # 数据库初始化配置
│       └── schemas/               # 表结构定义
│
├── styles/                          # 样式文件
│   ├── variables.scss              # CSS变量
│   ├── mixins.scss                # 混合器
│   └── common.scss                # 通用样式
│
├── config/                          # 配置文件
│   ├── env.js                     # 环境配置
│   └── app.config.js              # 应用配置
│
├── App.vue                         # 应用入口
├── main.js                         # 主入口文件
├── manifest.json                   # 应用配置
├── pages.json                      # 页面配置
├── uni.scss                        # 全局样式
├── package.json                    # 依赖配置
└── README.md                       # 项目说明
```

---

## 三、开发环境搭建

### 3.1 必需软件

| 软件 | 版本要求 | 下载地址 |
|-----|---------|---------|
| HBuilderX | 3.8.0+ | https://www.dcloud.io/hbuilderx.html |
| 微信开发者工具 | 最新稳定版 | https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html |
| Node.js | 16.0+ | https://nodejs.org/（可选，用于后续npm相关操作） |

### 3.2 环境配置步骤

#### 步骤1：安装HBuilderX

1. 下载HBuilderX
2. 解压并运行
3. 安装uni-app插件（工具 -> 插件安装 -> uni-app）

#### 步骤2：安装微信开发者工具

1. 下载微信开发者工具
2. 安装并运行
3. 登录微信账号

#### 步骤3：创建uni-app项目

1. 打开HBuilderX
2. 点击「文件」->「新建」->「项目」
3. 选择项目类型：
   - 如果是全新项目，选择「uni-app」->「默认模板」
   - 如果已有文档参考，选择「uni-app」->「默认模板」后手动创建目录结构
4. 填写项目信息：
   - 项目名称：My_School_Store_Tool
   - 文件夹路径：选择保存位置
   - Vue版本：选择Vue3（推荐）
   - 模板：默认模板
5. 点击「创建」按钮

**提示**：本项目是基于uni-app的全新开发，使用「默认模板」创建后，需要按照第二章的项目目录结构手动创建各个目录和文件。

#### 步骤4：配置云开发

1. 在HBuilderX中，右键项目根目录
2. 选择「新建」->「uniCloud云开发环境」，选择「腾讯云」
3. 系统会自动创建 `uniCloud` 目录
4. 右键 `uniCloud` 目录 -> 「关联云服务空间」
5. 选择或创建云服务空间（需要登录DCloud账号）
6. 等待关联完成

#### 步骤5：配置环境变量

在云开发控制台配置以下环境变量：

```
MOONSHOT_API_KEY=your-moonshot-api-key
JWT_SECRET=your-jwt-secret
```

#### 步骤6：运行项目

1. 运行 -> 运行到小程序模拟器 -> 微信开发者工具
2. 微信开发者工具会自动打开

### 3.3 云开发初始化

```javascript
// 调用初始化云函数
uniCloud.callFunction({
    name: 'initDatabase'
}).then(res => {
    console.log('数据库初始化完成');
});
```

---

## 四、核心功能开发指南

### 4.1 用户登录流程

```javascript
// pages/login/login.vue

export default {
    data() {
        return {
            canIUse: uni.canIUse('button.open-type.getUserInfo')
        }
    },
    methods: {
        // 获取微信登录code
        async login() {
            try {
                const loginRes = await uni.login({
                    provider: 'weixin'
                });

                // 调用云函数登录
                const res = await uniCloud.callFunction({
                    name: 'login',
                    data: {
                        code: loginRes.code,
                        userInfo: this.userInfo
                    }
                });

                if (res.result.code === 0) {
                    const { userId, token, hasRole } = res.result.data;

                    // 保存用户信息
                    uni.setStorageSync('userId', userId);
                    uni.setStorageSync('token', token);
                    this.$store.commit('user/setUserId', userId);

                    // 检查是否需要选择角色
                    if (!hasRole) {
                        uni.redirectTo({ url: '/pages/role/role' });
                    } else {
                        uni.switchTab({ url: '/pages/index/index' });
                    }
                }
            } catch (error) {
                console.error('登录失败:', error);
                uni.showToast({
                    title: '登录失败，请重试',
                    icon: 'none'
                });
            }
        },

        // 获取用户信息
        getUserInfo(e) {
            this.userInfo = e.detail.userInfo;
            this.login();
        }
    }
}
```

### 4.2 文章列表开发

```javascript
// pages/index/index.vue

export default {
    data() {
        return {
            currentTab: 0,
            tabs: [
                { name: '全部', category: '' },
                { name: '通知公告', category: 'notice' },
                { name: '学术动态', category: 'academic' },
                { name: '社团活动', category: 'activity' },
                { name: '生活服务', category: 'service' }
            ],
            articles: [],
            recommended: [],
            page: 1,
            hasMore: true,
            loading: false
        }
    },
    onLoad() {
        this.loadArticles();
    },
    onPullDownRefresh() {
        this.page = 1;
        this.hasMore = true;
        this.loadArticles(true);
    },
    onReachBottom() {
        if (this.hasMore && !this.loading) {
            this.page++;
            this.loadArticles();
        }
    },
    methods: {
        // 加载文章列表
        async loadArticles(refresh = false) {
            if (this.loading) return;
            this.loading = true;

            try {
                const userId = this.$store.state.user.userId;
                const category = this.tabs[this.currentTab].category;

                const res = await uniCloud.callFunction({
                    name: 'getArticles',
                    data: {
                        userId,
                        category,
                        page: this.page,
                        pageSize: 15,
                        refresh
                    }
                });

                if (res.result.code === 0) {
                    const { articles, hasMore, total } = res.result.data;
                    const { recommended = [] } = res.result;

                    if (refresh || this.page === 1) {
                        this.articles = articles;
                        this.recommended = recommended;
                    } else {
                        this.articles = [...this.articles, ...articles];
                    }

                    this.hasMore = hasMore;
                }
            } catch (error) {
                console.error('加载文章失败:', error);
            } finally {
                this.loading = false;
                uni.stopPullDownRefresh();
            }
        },

        // 切换Tab
        onTabChange(index) {
            if (this.currentTab === index) return;
            this.currentTab = index;
            this.page = 1;
            this.hasMore = true;
            this.loadArticles();
        },

        // 点击文章
        onArticleClick(article) {
            uni.navigateTo({
                url: `/pages/detail/detail?id=${article._id}`
            });
        }
    }
}
```

### 4.3 搜索功能开发

```javascript
// pages/search/search.vue

export default {
    data() {
        return {
            keyword: '',
            articles: [],
            hotKeywords: [],
            searchHistory: [],
            showHistory: true,
            loading: false
        }
    },
    onLoad() {
        this.loadHotKeywords();
        this.loadSearchHistory();
    },
    methods: {
        // 执行搜索
        async doSearch() {
            if (!this.keyword.trim()) return;

            this.loading = true;
            this.showHistory = false;

            try {
                const userId = this.$store.state.user.userId;
                const res = await uniCloud.callFunction({
                    name: 'searchArticles',
                    data: {
                        userId,
                        keyword: this.keyword,
                        page: 1,
                        pageSize: 20
                    }
                });

                if (res.result.code === 0) {
                    this.articles = res.result.data.articles;
                    this.hotKeywords = res.result.hotKeywords || [];

                    // 保存搜索历史
                    this.saveSearchHistory();
                }
            } catch (error) {
                console.error('搜索失败:', error);
            } finally {
                this.loading = false;
            }
        },

        // 加载热门搜索
        async loadHotKeywords() {
            const res = await uniCloud.callFunction({
                name: 'getSystemConfig',
                data: {
                    keys: ['hot_search_limit']
                }
            });

            if (res.result.code === 0) {
                // 从云数据库获取热门搜索
                const db = uniCloud.database();
                const hotRes = await db.collection('hot_keywords')
                    .orderBy('count', 'desc')
                    .limit(10)
                    .get();
                this.hotKeywords = hotRes.data;
            }
        },

        // 加载搜索历史
        loadSearchHistory() {
            this.searchHistory = uni.getStorageSync('searchHistory') || [];
        },

        // 保存搜索历史
        saveSearchHistory() {
            let history = uni.getStorageSync('searchHistory') || [];
            history = history.filter(item => item !== this.keyword);
            history.unshift(this.keyword);
            history = history.slice(0, 10);
            uni.setStorageSync('searchHistory', history);
            this.searchHistory = history;

            // 上报搜索记录
            uniCloud.callFunction({
                name: 'reportSearch',
                data: {
                    userId: this.$store.state.user.userId,
                    keyword: this.keyword,
                    resultCount: this.articles.length
                }
            });
        }
    }
}
```

---

## 五、开发规范

### 5.1 命名规范

| 类型 | 规范 | 示例 |
|-----|------|------|
| 文件名 | kebab-case | article-card.vue |
| 组件名 | PascalCase | ArticleCard |
| 变量名 | camelCase | articleCount |
| 常量名 | UPPER_SNAKE_CASE | API_BASE_URL |
| 函数名 | camelCase | loadArticles |
| 类名 | PascalCase | ArticleService |

### 5.2 代码风格

```javascript
// 使用ESLint推荐的代码风格
{
  "extends": [
    "plugin:vue/recommended",
    "eslint:recommended"
  ],
  "rules": {
    "indent": ["error", 2],
    "quotes": ["error", "single"],
    "semi": ["error", "never"],
    "no-console": "warn",
    "no-debugger": "warn"
  }
}
```

### 5.3 注释规范

```javascript
/**
 * 加载文章列表
 * @param {Object} params - 请求参数
 * @param {string} params.userId - 用户ID
 * @param {string} params.category - 文章分类
 * @param {number} params.page - 页码
 * @param {number} params.pageSize - 每页数量
 * @returns {Promise<Object>} 返回文章列表
 */
async function loadArticles(params) {
    // 实现代码
}
```

---

## 六、测试指南

### 6.1 单元测试

使用Jest进行单元测试：

```javascript
// tests/utils/format.test.js
import { formatDate, formatTime } from '@/utils/format';

describe('format工具函数', () => {
    test('formatDate格式化日期', () => {
        expect(formatDate(1707456000000)).toBe('2024-02-09');
    });

    test('formatTime格式化时间', () => {
        expect(formatTime(1707456000000)).toBe('14:00');
    });
});
```

### 6.2 集成测试

使用微信开发者工具进行真机调试和测试。

### 6.3 性能测试

使用微信开发者工具性能面板测试：

- 启动时间
- 首屏渲染时间
- 页面切换流畅度
- 内存占用

---

## 七、部署上线

### 7.1 微信小程序发布流程

1. **代码审核准备**
   - 检查隐私政策
   - 检查用户协议
   - 确认个人备案限制

2. **上传代码**
   - 微信开发者工具 -> 上传
   - 填写版本号和备注

3. **提交审核**
   - 登录微信公众平台
   - 版本管理 -> 提交审核
   - 填写审核说明

4. **审核通过后发布**
   - 审核通过后发布上线

### 7.2 云函数部署

```bash
# 方式1：HBuilderX部署
右键云函数 -> 上传部署

# 方式2：命令行部署
cd uniCloud/cloudfunctions/你的云函数
npm install
cd ../..
uniCloud deploy your-cloudfunction
```

### 7.3 数据库初始化

```javascript
// 调用初始化云函数
uniCloud.callFunction({
    name: 'initDatabase'
}).then(res => {
    console.log('数据库初始化完成');
});
```

---

## 八、运维监控

### 8.1 云开发监控

在云开发控制台查看：

- 云函数调用统计
- 云数据库查询统计
- 存储空间使用情况
- 错误日志

### 8.2 常见问题处理

| 问题 | 原因 | 解决方案 |
|-----|------|---------|
| 云函数调用失败 | 权限不足 | 检查数据库权限配置 |
| AI处理超时 | 内容过长 | 设置合理的超时时间 |
| 数据同步失败 | 数据源不可用 | 检查数据源配置 |
| 图片加载慢 | 图片过大 | 使用CDN加速 |

---

## 九、项目进度规划

| 阶段 | 时间 | 主要任务 | 产出 |
|-----|------|---------|------|
| 第一周 | 第1-7天 | 项目初始化、环境搭建、基础框架 | 可运行的空项目 |--完成
| 第二周 | 第8-14天 | 用户登录、角色选择、首页开发 | 用户体系 + 首页 |
| 第三周 | 第15-21天 | 发现页、搜索功能开发 | 发现 + 搜索 |
| 第四周 | 第22-28天 | 详情页、收藏功能开发 | 详情 + 收藏 |
| 第五周 | 第29-35天 | 个人中心、消息中心开发 | 个人中心 |
| 第六周 | 第36-42天 | 云函数开发、数据同步 | 完整后端 |
| 第七周 | 第43-49天 | 性能优化、测试、修复bug | 稳定版本 |
| 第八周 | 第50-56天 | 提交审核、准备上线 | 上线版本 |

---

## 十、常见问题FAQ

### Q1: 个人备案小程序能否使用微信登录？

A: 可以。个人备案小程序支持使用 `wx.login` 和 `getUserProfile` 进行用户身份验证。

### Q2: 个人备案小程序能否使用消息推送？

A: 不能。个人备案小程序不支持模板消息和订阅消息的主动推送。解决方案是提供"我的-消息"页面，用户主动查看更新。

### Q3: 数据采集是否合规？

A: 个人备案小程序应使用合法的数据源，如公开RSS、公开API等。不建议使用爬虫采集非公开内容。本项目建议使用公开RSS源或手动录入。

### Q4: Moonshot API调用成本如何控制？

A: 建议设置合理的调用限制，如：
- 每日最大调用次数
- 单次处理字数限制
- 缓存已处理的内容

### Q5: 如何保证数据安全？

A: 措施包括：
- 云数据库权限控制
- 敏感数据加密
- API防刷限流
- 定期数据备份

---

## 附录

### A. 相关文档

- [完整需求文档.md](./完整需求文档.md)
- [数据库设计文档.md](./数据库设计文档.md)
- [API接口文档.md](./API接口文档.md)
- [云函数设计文档.md](./云函数设计文档.md)

### B. 外部资源

- [uni-app官方文档](https://uniapp.dcloud.net.cn/)
- [DCloud云开发文档](https://doc.dcloud.net.cn/uniCloud/)
- [微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [Moonshot API文档](https://platform.moonshot.cn/docs/intro)

### C. 联系方式

如有问题，请联系项目维护者。

---

**文档版本**: v1.0
**最后更新**: 2024-02-09
