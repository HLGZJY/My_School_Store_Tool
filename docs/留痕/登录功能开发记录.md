# 登录功能开发记录

## 开发时间
2024-02-10

---

## 一、功能概述

实现了微信一键登录功能，符合个人备案小程序要求，仅支持微信登录方式。

---

## 二、实现描述

### 2.1 前端登录页面
**文件**：`pages/login/login.vue`

- 微信一键登录按钮（使用 `open-type="getUserInfo"`）
- 获取用户头像和昵称
- 调用登录云函数处理登录逻辑
- 登录成功后根据 `hasRole` 判断跳转到角色选择页或首页

### 2.2 用户状态管理
**文件**：`store/modules/user.js`

- Vuex 模块化管理用户状态
- 登录状态持久化（localStorage）
- 支持登出清除状态

### 2.3 登录云函数
**文件**：`uniCloud-aliyun/cloudfunctions/login/index.js`

- 使用 `context.OPENID` 或 `jscode2session` API 获取 openid
- 新用户自动创建用户记录
- 老用户更新登录时间
- 生成访问令牌（7天有效期）
- 记录登录日志

### 2.4 角色选择功能

#### 角色选择页
**文件**：`pages/role/role.vue`

- 三个角色选项：在校学生、教师、行政人员
- 选择角色后跳转到详情设置页

#### 角色详情设置页
**文件**：`pages/role/role-detail.vue`

- 学生：专业、年级、兴趣标签
- 教师：院系、职称、研究方向
- 行政人员：部门、职责范围
- 调用 `setUserRole` 云函数保存

#### 设置角色云函数
**文件**：`uniCloud-aliyun/cloudfunctions/setUserRole/index.js`

- 接收 userId、role、roleDetail 参数
- 更新用户角色信息
- 记录操作日志

---

## 三、参数整理

### 3.1 用户状态参数

| 参数名 | 来源 | 作用范围 |
|-------|------|---------|
| `userId` | store/user | 用户唯一标识，整个应用 |
| `token` | store/user | 访问令牌，整个应用 |
| `userInfo` | store/user | 用户信息，整个应用 |
| `openid` | 微信登录 | 用户微信标识，云函数 |

### 3.2 登录流程参数

| 参数名 | 所在文件 | 作用 |
|-------|---------|------|
| `code` | login.vue | 微信登录临时凭证，用于换取openid |
| `hasRole` | login.vue + 云函数 | 判断是否已选择角色，控制跳转 |
| `isNewUser` | login.vue + 云函数 | 判断是否为新用户 |

### 3.3 角色参数

| 参数名 | 类型 | 说明 |
|-------|------|------|
| `role` | string | 角色类型：student/teacher/admin |
| `roleDetail` | object | 角色详情（根据角色类型结构不同） |

---

## 四、微信配置

### 4.1 manifest.json 配置

```json
{
  "mp-weixin": {
    "appid": "wx21bdaa579562ec11",
    "appsecret": "1efd7d7a175d83ec611cac4758db9f51"
  }
}
```

### 4.2 云函数配置

微信小程序 AppID 和 AppSecret 硬编码在云函数中：
```javascript
const WX_APPID = 'wx21bdaa579562ec11';
const WX_APPSECRET = '1efd7d7a175d83ec611cac4758db9f51';
```

**注意**：生产环境应使用环境变量存储 AppSecret

---

## 五、登录流程图

```
小程序启动 (App.vue onLaunch)
        ↓
检查本地 userId + token
        ↓
   ┌────┴────┐
   ↓         ↓
无 token    有 token
   ↓          ↓
跳转登录页    调用 login 云函数（restore模式）
                ↓
            有 hasRole?
                ↓
         ┌────┴────┐
         ↓         ↓
        否        是
         ↓          ↓
    跳转角色选择页    留在首页
         ↓
    用户选择角色
         ↓
  跳转 role-detail 填写详情
         ↓
  调用 setUserRole 云函数
         ↓
    保存角色信息
         ↓
    跳转首页
```

---

## 六、数据库集合

### 6.1 users 集合

```javascript
{
    _id: "用户ID",
    openid: "微信OpenID",
    nickname: "用户昵称",
    avatar: "头像URL",
    role: "student/teacher/admin/null",
    roleDetail: { /* 根据角色类型结构 */ },
    settings: { fontSize, darkMode },
    stats: { readCount, collectCount, searchCount },
    subscribeSources: [],
    createTime: Number,
    updateTime: Number,
    lastLoginTime: Number
}
```

### 6.2 operation_logs 集合

```javascript
{
    _id: "日志ID",
    userId: "用户ID",
    action: "login/set_role",
    target: "user",
    detail: { /* 操作详情 */ },
    createTime: Number
}
```

---

## 七、测试验证

### 7.1 登录测试

| 测试场景 | 预期结果 | 验证 |
|---------|---------|------|
| 新用户首次登录 | 创建用户记录，`role` 为 null | ✅ |
| 老用户登录 | 更新登录时间，`role` 保持不变 | ✅ |
| 登录后跳转 | 无角色跳转角色选择页，有角色跳转首页 | ✅ |

### 7.2 角色选择测试

| 测试场景 | 预期结果 | 验证 |
|---------|---------|------|
| 选择学生角色 | 保存专业、年级、兴趣标签 | 待测试 |
| 选择教师角色 | 保存院系、职称、研究方向 | 待测试 |
| 选择行政人员角色 | 保存部门、职责范围 | 待测试 |

---

## 八、已知问题

### 8.1 已解决问题

| 问题 | 原因 | 解决方案 |
|-----|------|---------|
| `context.OPENID` 为空 | 本地调试不自动注入 | 添加 `jscode2session` API 换取 |
| `setUserRole` 云函数不存在 | 未创建该云函数 | 创建 `setUserRole` 云函数 |

### 8.2 待解决问题

无

---

## 九、注意事项

1. **个人备案限制**：本功能仅支持微信登录，不包含手机号、邮箱等登录方式
2. **令牌有效期**：7天，过期后需重新登录
3. **AppSecret 安全**：生产环境应使用环境变量
4. **域名配置**：微信后台需添加 `https://api.weixin.qq.com` 到 request 合法域名

---

## 十、下一步待办

- [x] 部署登录云函数到云端
- [x] 初始化云数据库（users、operation_logs 自动创建）
- [x] 测试登录完整流程
- [x] 创建 setUserRole 云函数
- [ ] 测试角色选择功能（学生/教师/行政人员）
