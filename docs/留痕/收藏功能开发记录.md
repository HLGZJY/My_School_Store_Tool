# 收藏功能开发记录

## 开发信息

| 项目 | 内容 |
|-----|------|
| 日期 | 2026-02-11 |
| 开发者 | Claude |
| 功能 | 收藏功能（收藏页面 + 首页收藏） |

## 文件结构

```
pages/collection/
└── collection.vue          # 收藏页面

pages/index/
└── index.vue               # 首页（添加收藏功能）

cloudfunctions/
├── collectArticle/         # 收藏/取消收藏
├── getCollections/         # 获取收藏列表
└── batchUncollect/         # 批量取消收藏

database/schemas/
└── collections.schema.json  # 收藏表结构
```

## 云函数

### collectArticle
| 参数 | 类型 | 说明 |
|-----|------|------|
| userId | String | 用户openid |
| articleId | String | 文章ID |
| action | String | 'collect' 或 'uncollect' |

**功能**：
- 收藏/取消收藏文章
- 保存文章快照（标题、来源、发布时间、分类）
- 更新文章收藏计数
- 更新用户收藏计数

### getCollections
| 参数 | 类型 | 说明 |
|-----|------|------|
| userId | String | 用户openid |
| category | String | 分类筛选（可选） |
| page | Number | 页码 |
| pageSize | Number | 每页数量 |

### batchUncollect
| 参数 | 类型 | 说明 |
|-----|------|------|
| userId | String | 用户openid |
| articleIds | Array | 文章ID数组 |

## 收藏表结构

```json
{
  "_id": "收藏记录ID",
  "openid": "用户OpenID",
  "articleId": "文章ID",
  "article": {
    "title": "标题",
    "sourceName": "来源",
    "publishTime": 发布时间,
    "category": "分类"
  },
  "collectTime": 收藏时间
}
```

## 用户数据联动问题

### 问题描述
收藏、阅读历史、搜索历史无法记录，因为用户登录后只存了 openid，但云函数需要用户的数据库文档ID（_id）

### 解决方案（方案A）
修改云函数直接使用前端传来的 openid 作为用户标识

| 云函数 | 修改内容 |
|-------|---------|
| collectArticle | 使用 `openid` 替代 `userDocId` |
| recordRead | 使用 `openid` 替代 `userDocId` |
| reportSearch | 添加 `openid` 字段保存搜索历史 |

### 用户表计数同步

| 云函数 | 同步内容 |
|-------|---------|
| collectArticle | `users.stats.collectCount` ±1 |
| batchUncollect | `users.stats.collectCount` -N |
| recordRead | `users.stats.readCount` +1 |
| reportSearch | `users.stats.searchCount` +1 |

## API兼容问题

### getOne() 方法不存在
云函数报 `db.collection(...).where(...).getOne is not a function`

**原因**：新版 uniCloud 移除了 `getOne()` 方法

**解决方案**：
```javascript
// 改为
const res = await db.collection('xxx').where({...}).get();
const data = res.data[0];
```

## 页面交互

### 首页左滑收藏
- 左滑显示收藏按钮
- 点击收藏/取消收藏
- 震动反馈

### 收藏页面
- 分类Tab筛选
- 单选/多选模式
- 批量取消收藏
- 下拉刷新

### 实时刷新机制

使用 `uni.$emit` 事件总线同步状态：

```javascript
// 收藏成功后发出事件
uni.$emit('collectChange', { articleId, collected: true })

// 相关页面监听
uni.$on('collectChange', this.onCollectChange)
```

## 修复记录

| 日期 | 问题 | 修复方案 |
|-----|------|---------|
| 2026-02-11 | getOne() 不存在 | 改为 get() + data[0] |
| 2026-02-11 | 收藏数不更新 | 同步更新 users.stats |
| 2026-02-11 | 页面不刷新 | 添加 onShow 刷新 + 事件总线 |
