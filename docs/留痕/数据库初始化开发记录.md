# 数据库初始化开发记录

## 开发时间
2026-02-9

---

## 一、功能概述

初始化登录功能所需的数据库集合和系统配置。

---

## 二、实现描述

### 2.1 JQL脚本
**文件**：`uniCloud-aliyun/database/JQL查询.jql`

- 添加集合索引说明文档
- 记录 users 和 operation_logs 集合的索引需求

### 2.2 初始化云函数
**文件**：`uniCloud-aliyun/cloudfunctions/initDatabase/index.js`

- 检查/创建 users 集合
- 检查/创建 operation_logs 集合
- 初始化登录相关系统配置

---

## 三、索引配置

### 3.1 users 集合索引

| 索引名称 | 索引字段 | 类型 | 说明 |
|---------|---------|------|------|
| idx_openid | openid | 唯一索引 | 微信OpenID，防止重复注册 |
| idx_createTime | createTime | 普通索引 | 按注册时间排序 |

### 3.2 operation_logs 集合索引

| 索引名称 | 索引字段 | 类型 | 说明 |
|---------|---------|------|------|
| idx_userId | userId | 普通索引 | 按用户查询 |
| idx_action | action | 普通索引 | 按操作类型筛选 |
| idx_createTime_ttl | createTime | TTL索引 | 90天自动过期 |

### 3.3 创建索引步骤

1. 登录 [uniCloud控制台](https://unicloud.dcloud.net.cn)
2. 选择云数据库
3. 分别点击 users 和 operation_logs 集合
4. 在"索引管理"中添加上述索引

---

## 四、系统配置

初始化以下登录相关配置：

| 配置键 | 配置值 | 说明 |
|-------|-------|------|
| login_token_expire | 604800000 | 令牌有效期，7天（毫秒） |
| login_max_retry_count | 5 | 最大重试次数 |

---

## 五、使用说明

### 5.1 方式一：JQL脚本验证
1. 在 HBuilderX 中打开 `uniCloud-aliyun/database/JQL查询.jql`
2. 选中最后的查询语句
3. 按 F5 运行，验证集合是否存在

### 5.2 方式二：云函数初始化
1. 右键 `uniCloud-aliyun/cloudfunctions/initDatabase`
2. 选择"上传部署"
3. 在云函数列表中点击"调用"

### 5.3 方式三：自动初始化
- `users` 和 `operation_logs` 集合会在首次登录时自动创建
- 索引需手动在控制台创建

---

## 六、注意事项

1. **索引创建**：JQL无法创建索引，必须在云数据库控制台手动操作
2. **集合创建**：登录云函数会自动创建所需集合，无需手动创建
3. **首次登录**：新用户首次登录时会自动创建用户记录

---

## 七、下一步待办

- [] 在云数据库控制台创建索引
- [ ] 部署 login 和 initDatabase 云函数
- [ ] 测试登录完整流程
