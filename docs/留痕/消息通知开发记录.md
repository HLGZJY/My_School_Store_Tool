# 消息通知开发记录

## 开发信息

| 项目 | 内容 |
|-----|------|
| 日期 | 2026-02-11 |
| 开发者 | Claude |
| 功能 | 消息通知列表与已读管理 |

## 文件结构

```
pages/message/
└── message.vue            # 消息通知页面

cloudfunctions/
├── getMessages/          # 获取消息列表
└── markMessageRead/      # 标记已读

database/schemas/
└── messages.schema.json   # 消息表结构
```

## 云函数

### getMessages
| 参数 | 类型 | 说明 |
|-----|------|------|
| userId | String | 用户openid |
| type | String | 'all'/'unread'/'system' |
| page | Number | 页码 |
| pageSize | Number | 每页数量 |

**返回数据**：
```json
{
  "messages": [...],
  "unreadCount": 未读数量,
  "hasMore": 是否有更多
}
```

### markMessageRead
| 参数 | 类型 | 说明 |
|-----|------|------|
| userId | String | 用户openid |
| messageId | String | 消息ID（可选） |
| all | Boolean | 全部标记已读（可选） |

## 消息表结构

```json
{
  "_id": "消息ID",
  "openid": "用户OpenID",
  "title": "消息标题",
  "content": "消息内容",
  "type": "system | activity | update",
  "isRead": false,
  "link": "跳转链接（可选）",
  "createTime": 创建时间
}
```

## 消息类型

| 类型 | 说明 | 用途 |
|-----|------|------|
| system | 系统通知 | 平台公告、系统维护 |
| activity | 活动提醒 | 订阅的更新提醒 |
| update | 更新通知 | 关注内容的更新 |

## 页面功能

### 消息列表
| 功能 | 说明 |
|-----|------|
| 未读高亮 | 未读消息绿色背景 + 左侧边框 |
| 时间显示 | 相对时间（刚刚/x小时前/昨天） |
| 全部已读 | 顶部按钮，一键标记 |
| 点击跳转 | 支持跳转任意页面 |

### 交互逻辑
```javascript
// 点击消息
handleMessageClick(item) {
  if (!item.isRead) {
    await markAsRead(item._id)
    item.isRead = true
  }
  // 跳转
  if (item.link) uni.navigateTo({ url: item.link })
}

// 全部已读
markAllRead() {
  // 确认后调用云函数
  // 更新本地状态
}
```

## 与我的页面联动

消息页面的未读数量会在我的页面菜单显示红点：

```javascript
// mine.vue 调用 getMessages 获取未读数
const res = await uniCloud.callFunction({
  name: 'getMessages',
  data: { userId: openid, type: 'unread' }
})
unreadCount = res.result.data.unreadCount
```

## 测试情况

| 测试项 | 状态 | 说明 |
|-------|------|------|
| 消息列表展示 | ⏳ 待测试 |
| 未读状态显示 | ⏳ 待测试 |
| 单条标记已读 | ⏳ 待测试 |
| 全部标记已读 | ⏳ 待测试 |
| 跳转功能 | ⏳ 待测试 |
| 我的页面未读红点 | ⏳ 待测试 |
