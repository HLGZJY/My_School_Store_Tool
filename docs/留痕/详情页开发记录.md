# 详情页开发记录

## 开发信息

| 项目 | 内容 |
|-----|------|
| 日期 | 2026-02-11 |
| 开发者 | Claude |
| 功能 | 文章详情页 |

## 文件结构

```
pages/detail/
└── detail.vue              # 详情页（435行）
```

## 页面功能

### 顶部导航栏
- 返回按钮
- 标题显示
- 分享按钮

### 文章信息区
- 标题（20px加粗）
- 元信息：来源 | 时间 | 阅读量
- 标签展示（来源标签 + 角色标签）

### AI摘要区
- 仅当文章有摘要时显示
- 绿色背景卡片

### 正文内容
- 使用 rich-text 组件渲染
- 支持HTML内容

### 相关推荐
- 同一来源的最新文章
- 最多3条
- 点击跳转到对应详情

### 底部操作栏
- 收藏按钮（红心图标）
- 打开原文按钮

## 云函数

| 云函数 | 功能 | 数据表 |
|-------|------|--------|
| getArticleDetail | 获取文章详情 | articles, collections |
| collectArticle | 收藏/取消收藏 | collections, articles |
| recordRead | 记录阅读历史 | readHistory |

## getArticleDetail 功能

```javascript
// 输入参数
{ articleId: string }

// 返回数据
{
    _id,
    title,
    summary,
    content,
    sourceName,
    sourceId,
    category,
    categoryName,
    tags: { role: [], urgency: [] },
    urgency,
    publishTime,
    originalUrl,
    stats: { viewCount, collectCount },
    relatedArticles: [{ _id, title, sourceName, publishTime }]
}
```

## collectArticle 功能

```javascript
// 输入参数
{ userId, articleId, action: 'collect' | 'uncollect' }

// 返回数据
{ code: 0, message: 'success', data: { collected: boolean } }
```

## recordRead 功能

```javascript
// 输入参数
{ userId, articleId, duration }

// 返回数据
{ code: 0, message: 'success', data: null }
```

## 交互设计

| 交互 | 行为 |
|-----|------|
| 点击收藏 | 调用 collectArticle，切换收藏状态 |
| 点击打开原文 | H5新窗口打开，小程序复制链接 |
| 点击分享 | 唤起分享菜单 |
| 点击相关推荐 | 跳转到对应文章详情 |

## 测试情况

| 测试项 | 状态 | 说明 |
|-------|------|------|
| 文章详情加载 | ⏳ 待测试 | 需部署云函数后测试 |
| 收藏功能 | ⏳ 待测试 | 需部署云函数后测试 |
| 阅读记录 | ⏳ 待测试 | 需部署云函数后测试 |
| 相关推荐 | ⏳ 待测试 | 需部署云函数后测试 |
| 打开原文 | ⏳ 待测试 | H5/小程序环境分别测试 |

## 待完善

- [x] 详情页前端页面 ✅
- [x] getArticleDetail 云函数 ✅
- [x] collectArticle 云函数 ✅
- [x] recordRead 云函数 ✅
- [ ] 测试真实数据

## 修复记录

| 日期 | 问题 | 修复方案 |
|-----|------|---------|
| 2026-02-11 | 云函数不存在 | 创建 getArticleDetail、collectArticle、recordRead |
| 2026-02-11 | 收藏/阅读历史无法记录 | 方案A：云函数直接使用前端传来的 openid |

## 用户数据联动问题说明

### 问题根因
- 用户登录后，前端仅存储 `openid`（微信用户唯一标识）
- 云函数内部使用 JQL 的 `{ openid: '{openid}' }` 语法获取用户文档ID
- 但 `{openid: '{openid}'}` 在客户端调用时无法正确替换，导致查询失败

### 临时方案（方案A）
直接使用前端传来的 openid 作为用户标识，修改的云函数：

```javascript
// collectArticle, recordRead 修改前
.where({ userId: userDocId, ... })

// collectArticle, recordRead 修改后
.where({ openid: openid, ... })  // 直接使用前端传来的 openid
```

### 后续优化方向（方案B）
1. **登录时获取文档ID**: 登录成功后，同时查询并存储用户的数据库文档ID
2. **数据迁移**: 将现有 collections、readHistory、searchHistory 表中的 `openid` 改为 `_id`
3. **统一用户标识**: 前端和后端都使用用户数据库文档ID作为唯一标识
